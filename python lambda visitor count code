import json
import boto3
import os

# Initialize dynamodb boto3 object
dynamodb = boto3.resource('dynamodb')
# Set dynamodb table name variable from env
ddbTableName = os.environ['databaseName']
table = dynamodb.Table(ddbTableName)

def lambda_handler(event, context):
    try:
        # Try to update the item by incrementing the visitor count
        ddbResponse = table.update_item(
            Key={
                'id': 'visitor_count'
            },
            UpdateExpression='SET visitor_count = if_not_exists(visitor_count, :start) + :inc',
            ExpressionAttributeValues={
                ':start': 0,
                ':inc': 1
            },
            ReturnValues="UPDATED_NEW"
        )
    except Exception as e:
        # Handle potential errors
        return {
            'statusCode': 500,
            'body': json.dumps({'error': str(e)})
        }

    # Extract the updated visitor count from the response
    visitor_count = ddbResponse['Attributes']['visitor_count']

    # Format dynamodb response into a variable
    responseBody = json.dumps({"count": int(visitor_count)})

    # Create API response object
    apiResponse = {
        "isBase64Encoded": False,
        "statusCode": 200,
        'headers': {
            'Access-Control-Allow-Headers': 'Content-Type',
            'Access-Control-Allow-Origin': '*',
            'Access-Control-Allow-Methods': 'OPTIONS,POST,GET'
        },
        "body": responseBody
    }

    # Return API response object
    return apiResponse

